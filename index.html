<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Yƒ±lƒ±n Hangi G√ºnleri Neredeyim?</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üóìÔ∏è</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
<style>
:root{
  --bg:#0b0d12;--panel:#0f1219;--muted:#8b90a2;--text:#eef2f7;--brand:#7c5cff;
  --glass:rgba(255,255,255,.06);--border:rgba(255,255,255,.12);
  --radius:16px;--shadow:0 12px 30px rgba(0,0,0,.35);
  -webkit-text-size-adjust:100%;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:
  radial-gradient(1200px 800px at 85% -10%, rgba(124,92,255,.22), transparent 60%),
  radial-gradient(1000px 700px at -10% 20%, rgba(0,224,184,.16), transparent 60%),var(--bg);
  color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased
}
.container{max-width:1260px;margin:0 auto;padding:20px}
header{position:sticky;top:0;z-index:5;backdrop-filter:saturate(140%) blur(10px);
  background:linear-gradient(to bottom, rgba(11,13,18,.92), rgba(11,13,18,.55) 65%, transparent);
  border-bottom:1px solid var(--border)}
.header-row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.h-left h1{margin:0;font-size:clamp(20px,3.6vw,34px);letter-spacing:-.01em}
.h-left .subtitle{margin:6px 0 0;color:var(--muted);font-size:14px}
.header-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.btn{background:var(--glass);border:1px solid var(--border);color:var(--text);border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:700}
.btn:hover{filter:brightness(1.06)}
.btn-primary{background:linear-gradient(135deg,var(--brand),#5f48ff);border:none}
.btn-success{background:#18d4a3;border:none}
.year-badge{min-width:88px;text-align:center;font-weight:800;letter-spacing:.06em;background:linear-gradient(135deg,var(--brand),#5f48ff);border:none}

/* 3 / 2 / 1 ay */
.months{display:grid;gap:18px;margin-top:18px;grid-template-columns:repeat(3,minmax(320px,1fr))}
@media (max-width:1100px){.months{grid-template-columns:repeat(2,minmax(320px,1fr))}}
@media (max-width:700px){.months{grid-template-columns:repeat(1,minmax(280px,1fr))}}

.month{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}
.m-head{padding:10px 14px;font-weight:800;letter-spacing:.02em;border-bottom:1px solid var(--border);background:rgba(255,255,255,.03)}
.cal{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;padding:12px}
.wk{color:#c7cede;font-size:11px;opacity:.9;text-align:center;font-weight:600}

/* G√ºn h√ºcresi */
.day{position:relative;height:78px;border:1px solid rgba(255,255,255,.1);border-radius:10px;cursor:pointer;transition:transform .06s ease,border-color .2s ease,box-shadow .2s ease;display:grid;grid-template-rows:1fr auto auto;align-items:center;justify-items:center;gap:4px;background:rgba(255,255,255,.02);padding-top:2px;padding-bottom:6px}
.day:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.22)}
.dno{position:absolute;left:6px;top:4px;font-size:12px;color:#d7deea;opacity:.95;font-weight:700}
.day.disabled{opacity:.22;pointer-events:none}
.day.today{border-color:#9aa8ff;box-shadow:0 0 0 2px rgba(122,140,255,.35) inset}
.day.preview{border-color:#00e0b8;box-shadow:0 0 0 2px rgba(0,224,184,.35) inset}
.flag{width:22px;height:auto;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.35)}
.city{font-size:10px;line-height:1.1;max-width:100%;text-align:center;color:#e4e9f5;padding:0 4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

footer{margin:30px 0 24px;color:#9aa4b8;text-align:center;font-size:12px}
footer a{color:#c9d3ff;text-decoration:none;border-bottom:1px dashed rgba(201,211,255,.4)}

/* Dialoglar */
dialog{border:0;border-radius:18px;padding:0;background:var(--panel);color:var(--text);box-shadow:0 30px 80px rgba(0,0,0,.55)}
dialog::backdrop{background:rgba(6,9,16,.62);backdrop-filter:blur(4px)}
.modal-head{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.modal-body{padding:14px 16px;display:grid;gap:12px}
label{font-size:12px;color:#cbd2df}

/* iOS yakƒ±nla≈ütƒ±rma √∂nleme: input/select 16px+ */
input[type="text"],select,input[type="date"]{
  width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);
  background:#11141b;color:var(--text);font-size:16px; /* kritik */
  -webkit-appearance:none;appearance:none;touch-action:manipulation;
}
.modal-actions{display:flex;justify-content:flex-end;gap:10px;padding:12px 16px;border-top:1px solid var(--border)}
.btn-quiet{background:transparent;border:1px solid var(--border)}
#summaryDlg{width:min(900px,95vw)} #rangeDlg{width:min(520px,92vw)} #helpDlg{width:min(640px,94vw)} #settingsDlg{width:min(640px,94vw)} #delDlg{width:min(420px,90vw)}

/* √ñzet */
.sum-wrap{padding:0 16px 16px}
.sum-stats{display:flex;gap:8px;flex-wrap:wrap;padding:12px 16px 0}
.stat{padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:var(--glass);font-size:12px;font-weight:700}
.sum-controls{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;gap:8px}
.sum-controls label{display:flex;align-items:center;gap:8px;font-size:12px;color:#dbe3f5}
.sum-list{max-height:60vh;overflow:auto;padding:10px 2px 16px}
.group{margin:8px 0 12px}
.group h4{margin:10px 0 6px 16px;color:#dbe3f5;font-size:13px;opacity:.9}
.item{display:grid;grid-template-columns:auto auto 1fr;align-items:center;gap:10px;padding:10px 12px;margin:6px 8px;border:1px solid var(--border);border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02))}
.item .pick{margin-right:4px}
.item .iflag{width:20px;border-radius:3px}
.item .meta{display:flex;flex-direction:column;line-height:1.2}
.item .title{font-weight:700;font-size:13px}
.item .sub{font-size:12px;color:#c4ccdd}
.sum-empty{padding:18px;color:#cbd5e7;text-align:center}
.share-row{display:flex;gap:8px;justify-content:flex-end;padding:0 16px 12px}
.small{font-size:12px;color:#aab4c7}
hr.sep{border:0;border-top:1px solid var(--border);margin:.25rem 0}
</style>
</head>
<body>
<header>
  <div class="container header-row">
    <div class="h-left">
      <h1>Yƒ±lƒ±n Hangi G√ºnleri Neredeyim?</h1>
      <p class="subtitle">G√ºne tƒ±kla veya s√ºr√ºkle-bƒ±rak ile aralƒ±k se√ß ‚Üí √úlke/≈ûehir uygula.</p>
    </div>
    <div class="header-actions">
      <button class="btn" id="prevYear">‚Äπ</button>
      <div class="btn year-badge" id="yearLabel">YYYY</div>
      <button class="btn" id="nextYear">‚Ä∫</button>
      <button class="btn" id="rangeBtn" title="Tarih aralƒ±ƒüƒ±na toplu giri≈ü">üìç Blok</button>
      <button class="btn" id="helpBtn" title="Yardƒ±m">‚ùî</button>
      <button class="btn" id="settingsBtn" title="Yedekleme">‚öôÔ∏è</button>
      <button class="btn btn-primary" id="summaryBtn" title="Kayƒ±tlƒ± t√ºm yƒ±llarƒ±n √∂zetini g√∂ster">üìú √ñzet</button>
    </div>
  </div>
</header>

<main class="container"><section id="months" class="months" aria-live="polite"></section></main>
<footer>Developed by <a href="https://github.com/eylmz" target="_blank" rel="noreferrer">eylmz</a></footer>

<!-- √ñzet -->
<dialog id="summaryDlg">
  <div class="modal-head">
    <strong>√ñzet ‚Äî Hangi G√ºn Neredeydim?</strong>
    <button class="btn btn-quiet" onclick="summaryDlg.close()">Kapat</button>
  </div>
  <div class="sum-wrap" id="sumCapture">
    <div class="sum-stats" id="sumStats"></div>
    <div class="sum-controls">
      <label><input type="checkbox" id="toggleAll" checked> T√ºm√ºn√º se√ß</label>
      <div style="display:flex;gap:8px">
        <button class="btn" id="icsBtn">ICS indir (<span id="selCount">0</span>)</button>
      </div>
    </div>
    <div class="sum-list" id="sumList"></div>
  </div>
  <div class="share-row">
    <button class="btn" id="dlBtn">PNG indir</button>
    <button class="btn btn-success" id="shareBtn">üì§ G√∂rsel olarak payla≈ü</button>
  </div>
</dialog>

<!-- Blok giri≈ü -->
<dialog id="rangeDlg">
  <div class="modal-head">
    <strong>Blok Ekle (Tarih Aralƒ±ƒüƒ±)</strong>
    <button class="btn btn-quiet" onclick="rangeDlg.close()">Kapat</button>
  </div>
  <div class="modal-body">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div><label for="startDate">Ba≈ülangƒ±√ß</label><input id="startDate" type="date"/></div>
      <div><label for="endDate">Biti≈ü</label><input id="endDate" type="date"/></div>
    </div>
    <div><label for="rangeCountrySel">√úlke</label><select id="rangeCountrySel"></select></div>
    <div><label for="rangeCityInp">≈ûehir</label>
      <input id="rangeCityInp" type="text" placeholder="√ñrn. Berlin" inputmode="text" autocapitalize="words" autocomplete="off"/>
    </div>
    <div class="small">Not: Aralƒ±k birden √ßok aya ve yƒ±la yayƒ±labilir. <strong>Bo≈ü / Ev</strong> se√ßerseniz g√ºnler temizlenir.</div>
  </div>
  <div class="modal-actions"><button id="rangeApplyBtn" class="btn btn-primary">Uygula</button></div>
</dialog>

<!-- Silme onayƒ± -->
<dialog id="delDlg">
  <div class="modal-head">
    <strong id="delTitle">G√ºn√º Sil</strong>
    <button class="btn btn-quiet" onclick="delDlg.close()">Kapat</button>
  </div>
  <div class="modal-body">
    <div id="delInfo" class="small"></div>
  </div>
  <div class="modal-actions">
    <button class="btn btn-danger" id="delYes">Sil</button>
  </div>
</dialog>

<!-- Yardƒ±m -->
<dialog id="helpDlg">
  <div class="modal-head"><strong>Nasƒ±l Kullanƒ±lƒ±r?</strong><button class="btn btn-quiet" onclick="helpDlg.close()">Kapat</button></div>
  <div class="modal-body">
    <ul style="margin:0 0 6px 18px;line-height:1.5">
      <li><strong>Dolu</strong> g√ºne tƒ±kla ‚Üí silme onayƒ±.</li>
      <li>Bo≈ü g√ºne tƒ±kla veya <strong>s√ºr√ºkle-bƒ±rak</strong> ile aralƒ±k se√ß ‚Üí <em>Blok Ekle</em>.</li>
      <li><strong>√ñzet</strong>: Se√ßtiklerini <em>ICS</em> indir ya da <em>PNG</em> payla≈ü.</li>
      <li><strong>Yedekleme</strong>: Veriyi indir / veri y√ºkle.</li>
    </ul>
  </div>
</dialog>

<!-- Yedekleme -->
<dialog id="settingsDlg">
  <div class="modal-head"><strong>Yedekleme</strong><button class="btn btn-quiet" onclick="settingsDlg.close()">Kapat</button></div>
  <div class="modal-body">
    <div class="small">T√ºm verilerini indir veya y√ºkle.</div>
    <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
      <button class="btn" id="jsonExportBtn">Veriyi indir</button>
      <button class="btn" id="jsonImportBtn">Veri y√ºkle</button>
      <input type="file" id="jsonFile" accept="application/json" style="display:none">
    </div>
  </div>
</dialog>

<script>
(function(){'use strict';

/* ==== √úlkeler ==== */
const COUNTRIES_RAW=[["af","Afganistan"],["al","Arnavutluk"],["dz","Cezayir"],["ad","Andorra"],["ao","Angola"],["ag","Antigua ve Barbuda"],["ar","Arjantin"],["am","Ermenistan"],["au","Avustralya"],["at","Avusturya"],["az","Azerbaycan"],["bs","Bahamalar"],["bh","Bahreyn"],["bd","Banglade≈ü"],["bb","Barbados"],["by","Belarus"],["be","Bel√ßika"],["bz","Belize"],["bj","Benin"],["bt","Butan"],["bo","Bolivya"],["ba","Bosna-Hersek"],["bw","Botsvana"],["br","Brezilya"],["bn","Brunei"],["bg","Bulgaristan"],["bf","Burkina Faso"],["bi","Burundi"],["cv","Cabo Verde"],["kh","Kambo√ßya"],["cm","Kamerun"],["ca","Kanada"],["cf","Orta Afrika Cum."],["td","√áad"],["cl","≈ûili"],["cn","√áin"],["co","Kolombiya"],["km","Komorlar"],["cg","Kongo Cum."],["cr","Kosta Rika"],["ci","Fildi≈üi Sahili"],["hr","Hƒ±rvatistan"],["cu","K√ºba"],["cy","Kƒ±brƒ±s"],["cz","√áekya"],["cd","Kongo D.C. (DRC)"],["dk","Danimarka"],["dj","Cibuti"],["dm","Dominika"],["do","Dominik Cum."],["ec","Ekvador"],["eg","Mƒ±sƒ±r"],["sv","El Salvador"],["gq","Ekvator Ginesi"],["er","Eritre"],["ee","Estonya"],["sz","Esvatini"],["et","Etiyopya"],["fj","Fiji"],["fi","Finlandiya"],["fr","Fransa"],["ga","Gabon"],["gm","Gambiya"],["ge","G√ºrcistan"],["de","Almanya"],["gh","Gana"],["gr","Yunanistan"],["gd","Grenada"],["gt","Guatemala"],["gn","Gine"],["gw","Gine-Bissau"],["gy","Guyana"],["ht","Haiti"],["hn","Honduras"],["hu","Macaristan"],["is","ƒ∞zlanda"],["in","Hindistan"],["id","Endonezya"],["ir","ƒ∞ran"],["iq","Irak"],["ie","ƒ∞rlanda"],["il","ƒ∞srail"],["it","ƒ∞talya"],["jm","Jamaika"],["jp","Japonya"],["jo","√úrd√ºn"],["kz","Kazakistan"],["ke","Kenya"],["ki","Kiribati"],["kw","Kuveyt"],["kg","Kƒ±rgƒ±zistan"],["la","Laos"],["lv","Letonya"],["lb","L√ºbnan"],["ls","Lesotho"],["lr","Liberya"],["ly","Libya"],["li","Lihten≈ütayn"],["lt","Litvanya"],["lu","L√ºksemburg"],["mg","Madagaskar"],["mw","Malavi"],["my","Malezya"],["mv","Maldivler"],["ml","Mali"],["mt","Malta"],["mh","Marshall Adalarƒ±"],["mr","Moritanya"],["mu","Mauritius"],["mx","Meksika"],["fm","Mikronezya"],["md","Moldova"],["mc","Monako"],["mn","Moƒüolistan"],["me","Karadaƒü"],["ma","Fas"],["mz","Mozambik"],["mm","Myanmar"],["na","Namibya"],["nr","Nauru"],["np","Nepal"],["nl","Hollanda"],["nz","Yeni Zelanda"],["ni","Nikaragua"],["ne","Nijer"],["ng","Nijerya"],["kp","Kuzey Kore"],["mk","Kuzey Makedonya"],["no","Norve√ß"],["om","Umman"],["pk","Pakistan"],["pw","Palau"],["ps","Filistin Devleti"],["pa","Panama"],["pg","Papua Yeni Gine"],["py","Paraguay"],["pe","Peru"],["ph","Filipinler"],["pl","Polonya"],["pt","Portekiz"],["qa","Katar"],["ro","Romanya"],["ru","Rusya"],["rw","Ruanda"],["kn","Saint Kitts ve Nevis"],["lc","Saint Lucia"],["vc","Saint Vincent ve Grenadinler"],["ws","Samoa"],["sm","San Marino"],["st","Sao Tome ve Principe"],["sa","Suudi Arabistan"],["sn","Senegal"],["rs","Sƒ±rbistan"],["sc","Sey≈üeller"],["sl","Sierra Leone"],["sg","Singapur"],["sk","Slovakya"],["si","Slovenya"],["sb","Solomon Adalarƒ±"],["so","Somali"],["za","G√ºney Afrika"],["kr","G√ºney Kore"],["ss","G√ºney Sudan"],["es","ƒ∞spanya"],["lk","Sri Lanka"],["sd","Sudan"],["sr","Surinam"],["se","ƒ∞sve√ß"],["ch","ƒ∞svi√ßre"],["sy","Suriye"],["tj","Tacikistan"],["tz","Tanzanya"],["th","Tayland"],["tl","Doƒüu Timor"],["tg","Togo"],["to","Tonga"],["tt","Trinidad ve Tobago"],["tn","Tunus"],["tr","T√ºrkiye"],["tm","T√ºrkmenistan"],["tv","Tuvalu"],["ug","Uganda"],["ua","Ukrayna"],["ae","BAE"],["gb","Birle≈üik Krallƒ±k"],["us","ABD"],["uy","Uruguay"],["uz","√ñzbekistan"],["vu","Vanuatu"],["va","Vatikan"],["ve","Venezuela"],["vn","Vietnam"],["ye","Yemen"],["zm","Zambiya"],["zw","Zimbabve"]];
const COUNTRIES=[["","Bo≈ü / Ev"]].concat([...COUNTRIES_RAW].sort((a,b)=>a[1].localeCompare(b[1],"tr",{sensitivity:"base"})));
const COUNTRY_BY_CODE=COUNTRIES_RAW.reduce((a,[c,n])=>(a[c]=n,a),{});
const flagURL=c=>c?`https://flagcdn.com/w40/${c}.png`:"";

/* ==== DOM ==== */
const monthsEl=document.getElementById('months');
const yearLbl=document.getElementById('yearLabel');
const prevBtn=document.getElementById('prevYear');
const nextBtn=document.getElementById('nextYear');
const rangeBtn=document.getElementById('rangeBtn');
const helpBtn=document.getElementById('helpBtn');
const settingsBtn=document.getElementById('settingsBtn');
const summaryBtn=document.getElementById('summaryBtn');

const summaryDlg=document.getElementById('summaryDlg');
const rangeDlg=document.getElementById('rangeDlg');
const helpDlg=document.getElementById('helpDlg');
const settingsDlg=document.getElementById('settingsDlg');
const delDlg=document.getElementById('delDlg');
const delTitle=document.getElementById('delTitle');
const delInfo=document.getElementById('delInfo');
const delYes=document.getElementById('delYes');

const sumStats=document.getElementById('sumStats');
const sumList=document.getElementById('sumList');
const sumCapture=document.getElementById('sumCapture');
const shareBtn=document.getElementById('shareBtn');
const dlBtn=document.getElementById('dlBtn');
const toggleAll=document.getElementById('toggleAll');
const icsBtn=document.getElementById('icsBtn');
const selCountEl=document.getElementById('selCount');

const rangeCountrySel=document.getElementById('rangeCountrySel');
const rangeCityInp=document.getElementById('rangeCityInp');
const startDateInp=document.getElementById('startDate');
const endDateInp=document.getElementById('endDate');
const rangeApplyBtn=document.getElementById('rangeApplyBtn');

const jsonExportBtn=document.getElementById('jsonExportBtn');
const jsonImportBtn=document.getElementById('jsonImportBtn');
const jsonFile=document.getElementById('jsonFile');

rangeCountrySel.innerHTML=COUNTRIES.map(([c,n])=>`<option value="${c}">${n}</option>`).join('');

/* ==== STATE ==== */
let currentYear=new Date().getFullYear();
let yearData={};
const storageKey=y=>`ylk-${y}`;

/* ==== tarih yardƒ±mcƒ±larƒ± ==== */
function pad(n){return String(n).padStart(2,'0')}
function ymdLocal(d){return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`}
function parseDate(s){const [y,m,d]=s.split('-').map(Number);return new Date(y,m-1,d)}

/* ==== Yƒ±l ==== */
function loadYear(y){currentYear=y;yearData=JSON.parse(localStorage.getItem(storageKey(y))||"{}");yearLbl.textContent=y;renderYear()}
function saveYear(){localStorage.setItem(storageKey(currentYear),JSON.stringify(yearData))}

/* ==== Takvim ==== */
const lastDay=(y,m)=>new Date(y,m+1,0).getDate();
const dkey=(y,m,d)=>`${y}-${pad(m+1)}-${pad(d)}`;
function renderYear(){
  monthsEl.innerHTML="";
  const WEEK=["Pzt","Sal","√áar","Per","Cum","Cmt","Paz"], MONTHS=["Ocak","≈ûubat","Mart","Nisan","Mayƒ±s","Haziran","Temmuz","Aƒüustos","Eyl√ºl","Ekim","Kasƒ±m","Aralƒ±k"];
  for(let m=0;m<12;m++){
    const month=document.createElement('div');month.className='month';
    const mh=document.createElement('div');mh.className='m-head';mh.textContent=MONTHS[m];month.appendChild(mh);
    const cal=document.createElement('div');cal.className='cal';
    WEEK.forEach(w=>{const wk=document.createElement('div');wk.className='wk';wk.textContent=w;cal.appendChild(wk)});
    let startIndex=new Date(currentYear,m,1).getDay();startIndex=(startIndex===0)?6:startIndex-1;
    for(let i=0;i<startIndex;i++){const e=document.createElement('div');e.className='day disabled';cal.appendChild(e)}
    const ld=lastDay(currentYear,m);
    for(let d=1;d<=ld;d++){
      const cell=document.createElement('div');cell.className='day';cell.dataset.date=dkey(currentYear,m,d);
      const dno=document.createElement('div');dno.className='dno';dno.textContent=d;cell.appendChild(dno);
      applyCellData(cell);
      const t=new Date();if(t.getFullYear()===currentYear&&t.getMonth()===m&&t.getDate()===d){cell.classList.add('today')}
      attachDragHandlers(cell);
      attachClickHandler(cell);
      cal.appendChild(cell);
    }
    month.appendChild(cal);monthsEl.appendChild(month);
  }
}
function applyCellData(cell){
  [...cell.querySelectorAll('img.flag,.city')].forEach(e=>e.remove());
  const data=yearData[cell.dataset.date];if(!data)return;
  if(data.cc){const img=document.createElement('img');img.className='flag';img.alt=data.cc.toUpperCase();img.loading='lazy';img.referrerPolicy='no-referrer';img.src=flagURL(data.cc);cell.appendChild(img)}
  if(data.city){const c=document.createElement('div');c.className='city';c.textContent=data.city;cell.appendChild(c)}
}

/* ==== Blok ekle ==== */
function applyRange(startStr,endStr,cc,city){
  if(!startStr||!endStr)return;
  let s=parseDate(startStr),e=parseDate(endStr); if(e<s){const t=s;s=e;e=t}
  const touchYears=new Set();
  for(let d=new Date(s);d<=e;d.setDate(d.getDate()+1)){
    const y=d.getFullYear();touchYears.add(y);
    const key=storageKey(y);const obj=JSON.parse(localStorage.getItem(key)||"{}");
    const k=ymdLocal(d);
    if(!cc&&!city) delete obj[k]; else obj[k]={cc,city};
    localStorage.setItem(key,JSON.stringify(obj));
    if(y===currentYear){yearData[k]=obj[k]}
  }
  if(touchYears.has(currentYear)) renderYear();
}

/* Drag-select */
let dragActive=false,dragStart=null,dragEnd=null;
function dateMinMax(a,b){return a<=b?[a,b]:[b,a]}
function clearPreview(){document.querySelectorAll('.day.preview').forEach(el=>el.classList.remove('preview'))}
function highlightRange(a,b){const[s,e]=dateMinMax(a,b);clearPreview();document.querySelectorAll('.day[data-date]').forEach(el=>{const dt=el.dataset.date;if(dt>=s&&dt<=e)el.classList.add('preview')})}
function attachDragHandlers(el){
  el.addEventListener('pointerdown',ev=>{if(ev.button!==0)return;dragActive=true;dragStart=el.dataset.date;dragEnd=dragStart;el.setPointerCapture(ev.pointerId);highlightRange(dragStart,dragEnd)});
  el.addEventListener('pointerenter',()=>{if(!dragActive)return;dragEnd=el.dataset.date;highlightRange(dragStart,dragEnd)});
  el.addEventListener('pointerup',()=>{if(!dragActive)return;dragActive=false;clearPreview();const[s,e]=dateMinMax(dragStart,dragEnd);
    if(s===e && yearData[s]){ openDelete(s); } else { startDateInp.value=s; endDateInp.value=e; rangeCountrySel.value=""; rangeCityInp.value=""; rangeDlg.showModal(); }
  });
}
function attachClickHandler(el){
  el.addEventListener('click',()=>{
    const dt=el.dataset.date;
    if(yearData[dt]){ openDelete(dt); }
    else{ startDateInp.value=dt; endDateInp.value=dt; rangeCountrySel.value=""; rangeCityInp.value=""; rangeDlg.showModal(); }
  });
}

/* Silme onayƒ± */
let delDate=null;
function openDelete(dateStr){
  delDate=dateStr;
  const v=yearData[dateStr]||{};
  delTitle.textContent=new Date(dateStr).toLocaleDateString('tr-TR',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
  delInfo.innerHTML=`<div>Silinecek: <strong>${(v.city||'‚Äî')}${v.cc?` ‚Äî ${COUNTRY_BY_CODE[v.cc]||v.cc.toUpperCase()}`:''}</strong></div>`;
  delDlg.showModal();
}
delYes.addEventListener('click',()=>{
  if(!delDate){delDlg.close();return}
  delete yearData[delDate]; saveYear();
  const y=new Date(delDate).getFullYear(); const key=storageKey(y); const obj=JSON.parse(localStorage.getItem(key)||"{}"); delete obj[delDate]; localStorage.setItem(key,JSON.stringify(obj));
  const cell=document.querySelector(`.day[data-date="${delDate}"]`); if(cell) applyCellData(cell);
  delDlg.close();
});

/* ==== √ñzet ==== */
function getAllEntries(){const rows=[];for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(!k||!k.startsWith('ylk-'))continue;let obj;try{obj=JSON.parse(localStorage.getItem(k)||"{}")}catch{obj={}}for(const date in obj){if(!Object.prototype.hasOwnProperty.call(obj,date))continue;const v=obj[date];if(!v||(!v.cc&&!v.city))continue;rows.push({date,cc:v.cc||"",city:v.city||""})}}rows.sort((a,b)=>a.date.localeCompare(b.date));return rows}
function updateSelCount(){selCountEl.textContent=String(sumList.querySelectorAll('input.pick:checked').length)}
function renderSummary(){
  const rows=getAllEntries(); sumStats.innerHTML=""; sumList.innerHTML="";
  if(rows.length===0){sumList.innerHTML=`<div class="sum-empty">Kayƒ±t bulunamadƒ±.</div>`;updateSelCount();return}
  const uniq=a=>[...new Set(a)];
  const countryCount=uniq(rows.map(r=>r.cc).filter(Boolean)).length;
  const cityCount=uniq(rows.map(r=>r.city).filter(Boolean).map(s=>s.toLowerCase())).length;
  const years=uniq(rows.map(r=>r.date.slice(0,4)));
  [`Toplam G√ºn: ${rows.length}`,`√úlke: ${countryCount}`,`≈ûehir: ${cityCount}`,`Yƒ±llar: ${years.join(' ¬∑ ')}`].forEach(t=>{const s=document.createElement('div');s.className='stat';s.textContent=t;sumStats.appendChild(s)});
  const monthsTR=["Ocak","≈ûubat","Mart","Nisan","Mayƒ±s","Haziran","Temmuz","Aƒüustos","Eyl√ºl","Ekim","Kasƒ±m","Aralƒ±k"];
  let grp=""; rows.forEach(r=>{const y=r.date.slice(0,4),m=Number(r.date.slice(5,7))-1,g=`${y}-${pad(m+1)}`;if(g!==grp){grp=g;const div=document.createElement('div');div.className='group';const h=document.createElement('h4');h.textContent=`${y} ¬∑ ${monthsTR[m]}`;div.appendChild(h);sumList.appendChild(div)}const d=new Date(r.date);const line=d.toLocaleDateString('tr-TR',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});const item=document.createElement('div');item.className='item';item.dataset.date=r.date;const cb=document.createElement('input');cb.type='checkbox';cb.className='pick';cb.checked=true;cb.addEventListener('change',updateSelCount);const flag=document.createElement('img');flag.className='iflag';flag.alt=r.cc.toUpperCase();flag.loading='lazy';flag.src=r.cc?flagURL(r.cc):'';const meta=document.createElement('div');meta.className='meta';const t=document.createElement('div');t.className='title';t.textContent=(r.city||'‚Äî')+(r.cc?` ‚Äî ${COUNTRY_BY_CODE[r.cc]||r.cc.toUpperCase()}`:'');const sub=document.createElement('div');sub.className='sub';sub.textContent=line;meta.appendChild(t);meta.appendChild(sub);item.appendChild(cb);item.appendChild(flag);item.appendChild(meta);sumList.lastElementChild.appendChild(item)});
  updateSelCount();
}
async function createSummaryCanvas(){
  return html2canvas(sumCapture,{backgroundColor:'#0f1219',scale:2,useCORS:true,onclone:(doc)=>{const list=doc.getElementById('sumList');if(list){list.style.maxHeight='none';list.style.overflow='visible'}}});
}
async function shareSummaryAsImage(){try{const c=await createSummaryCanvas();const b=await new Promise(r=>c.toBlob(r,'image/png',0.95));const f=new File([b],'gezi-ozet.png',{type:'image/png'});if(navigator.canShare&&navigator.canShare({files:[f]})){await navigator.share({files:[f],title:'Gezi √ñzeti'})}else{const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download='gezi-ozet.png';a.click();URL.revokeObjectURL(u)}}catch(e){console.error(e);alert('G√∂rsel olu≈üturulamadƒ±.')}} 
async function downloadSummaryPng(){const c=await createSummaryCanvas();c.toBlob(b=>{const a=document.createElement('a');const u=URL.createObjectURL(b);a.href=u;a.download='gezi-ozet.png';a.click();URL.revokeObjectURL(u)},'image/png',0.95)}
function dateAdd(str,days){const[y,m,d]=str.split('-').map(Number);const dt=new Date(y,m-1,d);dt.setDate(dt.getDate()+days);return ymdLocal(dt)}
function icsEscape(s){return (s||'').replace(/([,;])/g,'\\$1').replace(/\n/g,'\\n')}
function exportICS(){
  const picks=[...sumList.querySelectorAll('.item')].filter(it=>it.querySelector('.pick').checked).map(it=>it.dataset.date);
  if(!picks.length){alert('L√ºtfen en az bir g√ºn se√ß.');return}
  const dict={};for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(!k||!k.startsWith('ylk-'))continue;Object.assign(dict,JSON.parse(localStorage.getItem(k)||"{}"))}
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//gezi-plani//TR//EN','CALSCALE:GREGORIAN','METHOD:PUBLISH'];
  picks.sort().forEach(date=>{const v=dict[date]||{};const title=[v.city,v.cc?(COUNTRY_BY_CODE[v.cc]||v.cc.toUpperCase()):''].filter(Boolean).join(' ‚Äî ')||'Seyahat';const DTSTART=date.replace(/-/g,'');const DTEND=dateAdd(date,1).replace(/-/g,'');const uid=`${date}-${(v.cc||'xx')}-${Math.random().toString(36).slice(2,8)}@gezi`;lines.push('BEGIN:VEVENT',`UID:${uid}`,`DTSTAMP:${DTSTART}T000000Z`,`DTSTART;VALUE=DATE:${DTSTART}`,`DTEND;VALUE=DATE:${DTEND}`,`SUMMARY:${icsEscape(title)}`,'END:VEVENT')});
  lines.push('END:VCALENDAR');const blob=new Blob([lines.join('\r\n')],{type:'text/calendar;charset=utf-8'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='gezi-ozet.ics';a.click();URL.revokeObjectURL(a.href)
}

/* ==== Veri indir / y√ºkle ==== */
function snapshotAll(){const obj={};for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(k&&k.startsWith('ylk-'))obj[k]=JSON.parse(localStorage.getItem(k)||"{}")}return obj}
function downloadJSON(){const blob=new Blob([JSON.stringify(snapshotAll(),null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='gezi-yedek.json';a.click();URL.revokeObjectURL(a.href)}
function applyImportedData(obj){
  if(!obj||typeof obj!=='object') return;
  Object.keys(obj).forEach(k=>{
    if(!k.startsWith('ylk-')||typeof obj[k]!=='object') return;
    const current=JSON.parse(localStorage.getItem(k)||"{}");
    const merged={...current,...obj[k]};
    localStorage.setItem(k,JSON.stringify(merged));
    if(k===storageKey(currentYear)) yearData=merged;
  });
  renderYear();
  if(summaryDlg.open) renderSummary();
}

/* ==== Events ==== */
prevBtn.addEventListener('click',()=>loadYear(currentYear-1));
nextBtn.addEventListener('click',()=>loadYear(currentYear+1));
rangeBtn.addEventListener('click',()=>{const t=new Date();startDateInp.value=ymdLocal(t);const t2=new Date(t);t2.setDate(t.getDate()+4);endDateInp.value=ymdLocal(t2);rangeCountrySel.value="";rangeCityInp.value="";rangeDlg.showModal()});
helpBtn.addEventListener('click',()=>helpDlg.showModal());
settingsBtn.addEventListener('click',()=>settingsDlg.showModal());
rangeApplyBtn.addEventListener('click',()=>{applyRange(startDateInp.value,endDateInp.value,rangeCountrySel.value.trim(),rangeCityInp.value.trim());rangeDlg.close()});
summaryBtn.addEventListener('click',()=>{renderSummary();summaryDlg.showModal()});
shareBtn.addEventListener('click',shareSummaryAsImage);
dlBtn.addEventListener('click',downloadSummaryPng);
toggleAll.addEventListener('change',()=>{sumList.querySelectorAll('input.pick').forEach(cb=>cb.checked=toggleAll.checked);updateSelCount()});
icsBtn.addEventListener('click',exportICS);
jsonExportBtn.addEventListener('click',downloadJSON);
jsonImportBtn.addEventListener('click',()=>jsonFile.click());
jsonFile.addEventListener('change',async e=>{const f=e.target.files&&e.target.files[0]; if(!f) return; const txt=await f.text(); try{applyImportedData(JSON.parse(txt)); alert('Veri y√ºklendi.')}catch{alert('Dosya okunamadƒ±')}});

/* ==== ƒ∞lk y√ºkleme ==== */
loadYear(new Date().getFullYear());

})();
</script>
</body>
</html>
